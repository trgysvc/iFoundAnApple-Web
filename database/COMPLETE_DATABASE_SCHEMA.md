# Complete Database Schema Documentation

Bu dosya Supabase'deki tüm tabloların yapısını ve RLS politikalarını içerir. Güncellemeler burada yapılır ve revize edilir.

**Son Güncelleme:** 24 Ekim 2025, Cuma - 14:30  
**Versiyon:** 2.0

---

## 📊 **TABLO YAPILARI**

### 1. **admin_permissions**
Admin yetkilerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| user_id | uuid | NO | null | User ID (FK) |
| role | text | NO | null | Role |
| permissions | jsonb | YES | '{}'::jsonb | Permissions |
| granted_by | uuid | YES | null | Granted by (FK) |
| granted_at | timestamp with time zone | YES | now() | Granted timestamp |
| expires_at | timestamp with time zone | YES | null | Expires timestamp |
| is_active | boolean | YES | true | Is active |
| notes | text | YES | null | Notes |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |

### 2. **audit_logs**
Sistemdeki tüm işlemleri loglayan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| event_type | character varying(50) | NO | null | Event type |
| event_category | character varying(30) | NO | null | Event category |
| event_action | character varying(30) | NO | null | Event action |
| event_severity | character varying(20) | YES | 'info'::character varying | Event severity |
| user_id | uuid | YES | null | User ID |
| session_id | character varying(255) | YES | null | Session ID |
| ip_address | inet | YES | null | IP address |
| user_agent | text | YES | null | User agent |
| resource_type | character varying(50) | YES | null | Resource type |
| resource_id | uuid | YES | null | Resource ID |
| parent_resource_type | character varying(50) | YES | null | Parent resource type |
| parent_resource_id | uuid | YES | null | Parent resource ID |
| old_values | jsonb | YES | null | Old values |
| new_values | jsonb | YES | null | New values |
| changes | jsonb | YES | null | Changes |
| event_description | text | NO | null | Event description |
| event_data | jsonb | YES | null | Event data |
| error_details | jsonb | YES | null | Error details |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| request_id | character varying(255) | YES | null | Request ID |
| correlation_id | character varying(255) | YES | null | Correlation ID |
| is_sensitive | boolean | YES | false | Is sensitive |
| retention_period_days | integer | YES | 2555 | Retention period |
| archived_at | timestamp with time zone | YES | null | Archived timestamp |
| application_version | character varying(50) | YES | null | Application version |
| environment | character varying(20) | YES | 'production'::character varying | Environment |
| tags | ARRAY | YES | null | Tags |

### 3. **cargo_codes**
Kargo kodlarını tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| device_id | uuid | NO | null | Device ID (FK) |
| payment_id | uuid | NO | null | Payment ID (FK) |
| code | character varying(20) | NO | null | Code |
| generated_by | uuid | NO | null | Generated by (FK) |
| cargo_company | character varying(50) | NO | null | Cargo company |
| status | character varying(20) | YES | 'active'::character varying | Status |
| expires_at | timestamp with time zone | YES | null | Expires timestamp |
| used_at | timestamp with time zone | YES | null | Used timestamp |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |
| cargo_status | character varying(20) | YES | 'pending'::character varying | Cargo status |

### 4. **cargo_companies**
Kargo şirketleri bilgilerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| code | character varying(20) | NO | null | Company code |
| name | character varying(100) | NO | null | Company name |
| api_endpoint | character varying(255) | YES | null | API endpoint |
| tracking_url_template | character varying(255) | YES | null | Tracking URL template |
| standard_delivery_days | integer | YES | 2 | Standard delivery days |
| express_delivery_days | integer | YES | 1 | Express delivery days |
| base_fee | numeric(8,2) | YES | 25.00 | Base fee |
| express_fee_multiplier | numeric(3,2) | YES | 1.5 | Express fee multiplier |
| is_active | boolean | YES | true | Is active |
| created_at | timestamp with time zone | YES | now() | Created timestamp |

### 5. **cargo_shipments**
Kargo gönderilerini takip eden tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| device_id | uuid | NO | null | Device ID (FK) |
| payment_id | uuid | YES | null | Payment ID (FK) |
| cargo_company | character varying(50) | NO | null | Cargo company |
| tracking_number | character varying(100) | YES | null | Tracking number |
| cargo_service_type | character varying(50) | YES | 'standard'::character varying | Service type |
| estimated_delivery_days | integer | YES | 2 | Estimated delivery days |
| sender_anonymous_id | character varying(20) | NO | null | Sender anonymous ID |
| receiver_anonymous_id | character varying(20) | NO | null | Receiver anonymous ID |
| sender_user_id | uuid | NO | null | Sender user ID (FK) |
| receiver_user_id | uuid | NO | null | Receiver user ID (FK) |
| sender_address_encrypted | text | YES | null | Sender address (encrypted) |
| receiver_address_encrypted | text | YES | null | Receiver address (encrypted) |
| status | character varying(30) | NO | 'created'::character varying | Shipment status |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |
| picked_up_at | timestamp with time zone | YES | null | Picked up timestamp |
| delivered_at | timestamp with time zone | YES | null | Delivered timestamp |
| package_weight | numeric(5,2) | YES | null | Package weight |
| package_dimensions | character varying(50) | YES | null | Package dimensions |
| declared_value | numeric(10,2) | YES | null | Declared value |
| cargo_fee | numeric(8,2) | NO | 25.00 | Cargo fee |
| delivery_confirmed_by_receiver | boolean | YES | false | Delivery confirmed |
| delivery_confirmation_date | timestamp with time zone | YES | null | Delivery confirmation date |
| delivery_signature | text | YES | null | Delivery signature |
| delivery_photos | ARRAY | YES | null | Delivery photos |
| special_instructions | text | YES | null | Special instructions |
| notes | text | YES | null | Notes |
| failure_reason | text | YES | null | Failure reason |
| cargo_code | character varying(20) | YES | null | Cargo code |
| delivery_confirmation_id | uuid | YES | null | Delivery confirmation ID (FK) |

### 6. **delivery_confirmations**
Teslimat onaylarını tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| device_id | uuid | NO | null | Device ID (FK) |
| payment_id | uuid | NO | null | Payment ID (FK) |
| cargo_shipment_id | uuid | NO | null | Cargo shipment ID (FK) |
| confirmed_by | uuid | NO | null | Confirmed by (FK) |
| confirmation_type | character varying(30) | NO | null | Confirmation type |
| confirmation_data | jsonb | YES | '{}'::jsonb | Confirmation data |
| confirmed_at | timestamp with time zone | YES | now() | Confirmed timestamp |
| created_at | timestamp with time zone | YES | now() | Created timestamp |

### 7. **device_models**
Cihaz modellerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| name | text | NO | null | Device name |
| createdAt | timestamp with time zone | NO | now() | Created timestamp |
| category | character varying(50) | YES | null | Category |
| model_name | character varying(100) | YES | null | Model name |
| specifications | text | YES | null | Specifications |
| repair_price | numeric(10,2) | YES | null | Repair price |
| ifoundanapple_fee | numeric(10,2) | YES | null | iFoundAnApple fee |
| fee_percentage | numeric(5,2) | YES | 10.00 | Fee percentage |
| is_active | boolean | YES | true | Is active |
| sort_order | integer | YES | 0 | Sort order |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |

### 8. **devices**
Kayıp/bulunan cihazları tutan ana tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| userId | uuid | NO | null | User ID (FK) |
| model | text | NO | null | Device model |
| serialNumber | text | NO | null | Serial number |
| status | text | NO | 'LOST'::text | Device status |
| color | text | YES | null | Device color |
| description | text | YES | null | Description |
| rewardAmount | numeric | YES | null | Reward amount |
| invoiceDataUrl | text | YES | null | Invoice data URL |
| exchangeConfirmedBy | ARRAY | YES | '{}'::uuid[] | Exchange confirmed by |
| created_at | timestamp with time zone | NO | now() | Created timestamp |
| invoice_url | text | YES | null | Invoice URL |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |
| lost_date | date | YES | null | Date when device was lost (YYYY-MM-DD) |
| lost_location | text | YES | null | Location where device was lost |
| cargo_code_id | uuid | YES | null | Cargo code ID (FK) |
| delivery_confirmed_at | timestamp with time zone | YES | null | Delivery confirmed timestamp |
| final_payment_distributed_at | timestamp with time zone | YES | null | Final payment distributed timestamp |

### 9. **escrow_accounts**
Escrow hesaplarını tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| payment_id | uuid | NO | null | Payment ID (FK) |
| device_id | uuid | NO | null | Device ID (FK) |
| holder_user_id | uuid | NO | null | Holder user ID (FK) |
| beneficiary_user_id | uuid | NO | null | Beneficiary user ID (FK) |
| total_amount | numeric(10,2) | NO | null | Total amount |
| reward_amount | numeric(10,2) | NO | null | Reward amount |
| service_fee | numeric(10,2) | NO | 0.00 | Service fee |
| cargo_fee | numeric(10,2) | NO | 0.00 | Cargo fee |
| net_payout | numeric(10,2) | NO | 0.00 | Net payout |
| status | character varying(20) | NO | 'pending'::character varying | Escrow status |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| held_at | timestamp with time zone | YES | null | Held timestamp |
| released_at | timestamp with time zone | YES | null | Released timestamp |
| refunded_at | timestamp with time zone | YES | null | Refunded timestamp |
| release_conditions | jsonb | NO | '[]'::jsonb | Release conditions |
| confirmations | jsonb | NO | '[]'::jsonb | Confirmations |
| currency | character varying(3) | YES | 'TRY'::character varying | Currency |
| notes | text | YES | null | Notes |
| admin_notes | text | YES | null | Admin notes |
| created_by | uuid | YES | null | Created by (FK) |
| released_by | uuid | YES | null | Released by (FK) |
| refunded_by | uuid | YES | null | Refunded by (FK) |
| escrow_type | character varying(20) | YES | 'standard'::character varying | Escrow type |
| auto_release_days | integer | YES | 30 | Auto release days |
| escrow_fee | numeric(10,2) | YES | 0.00 | Escrow fee |
| insurance_amount | numeric(10,2) | YES | 0.00 | Insurance amount |
| risk_assessment | character varying(20) | YES | 'low'::character varying | Risk assessment |
| compliance_verified | boolean | YES | false | Compliance verified |
| release_reason | text | YES | null | Release reason |
| refund_reason | text | YES | null | Refund reason |
| notification_sent | boolean | YES | false | Notification sent |
| reminder_sent_at | timestamp with time zone | YES | null | Reminder sent timestamp |
| last_activity_at | timestamp with time zone | YES | now() | Last activity timestamp |
| activity_log | jsonb | YES | '[]'::jsonb | Activity log |
| dispute_status | character varying(20) | YES | 'none'::character varying | Dispute status |
| dispute_reason | text | YES | null | Dispute reason |
| resolution_method | character varying(20) | YES | null | Resolution method |
| resolution_notes | text | YES | null | Resolution notes |
| processing_fee | numeric(10,2) | YES | 0.00 | Processing fee |
| platform_fee | numeric(10,2) | YES | 0.00 | Platform fee |
| total_fees | numeric(10,2) | YES | 0.00 | Total fees |
| net_amount | numeric(10,2) | YES | 0.00 | Net amount |
| metadata | jsonb | YES | '{}'::jsonb | Metadata |
| tags | ARRAY | YES | null | Tags |
| priority | character varying(10) | YES | 'normal'::character varying | Priority |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |
| gross_amount | numeric(10,2) | NO | 0.00 | Gross amount |
| gateway_fee | numeric(10,2) | NO | 0.00 | Gateway fee |

### 10. **final_payment_distributions**
Final ödeme dağıtımlarını tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| device_id | uuid | NO | null | Device ID (FK) |
| payment_id | uuid | NO | null | Payment ID (FK) |
| escrow_account_id | uuid | NO | null | Escrow account ID (FK) |
| total_amount | numeric(10,2) | NO | 0.00 | Total amount |
| cargo_fee | numeric(10,2) | NO | 0.00 | Cargo fee |
| reward_amount | numeric(10,2) | NO | 0.00 | Reward amount |
| service_fee | numeric(10,2) | NO | 0.00 | Service fee |
| gateway_transfer_id | character varying(200) | YES | null | Gateway transfer ID |
| cargo_transfer_id | character varying(200) | YES | null | Cargo transfer ID |
| reward_transfer_id | character varying(200) | YES | null | Reward transfer ID |
| service_transfer_id | character varying(200) | YES | null | Service transfer ID |
| status | character varying(20) | YES | 'pending'::character varying | Status |
| processed_at | timestamp with time zone | YES | null | Processed timestamp |
| failed_reason | text | YES | null | Failed reason |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |
| gross_amount | numeric(10,2) | NO | 0.00 | Gross amount |
| net_amount | numeric(10,2) | NO | 0.00 | Net amount |
| distribution_type | character varying(20) | YES | 'automatic'::character varying | Distribution type |

### 11. **financial_audit_trail**
Finansal audit trail tablosu.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | YES | null | Primary key |
| event_type | character varying(50) | YES | null | Event type |
| event_category | character varying(30) | YES | null | Event category |
| event_action | character varying(30) | YES | null | Event action |
| event_severity | character varying(20) | YES | null | Event severity |
| user_id | uuid | YES | null | User ID |
| session_id | character varying(255) | YES | null | Session ID |
| ip_address | inet | YES | null | IP address |
| user_agent | text | YES | null | User agent |
| resource_type | character varying(50) | YES | null | Resource type |
| resource_id | uuid | YES | null | Resource ID |
| parent_resource_type | character varying(50) | YES | null | Parent resource type |
| parent_resource_id | uuid | YES | null | Parent resource ID |
| old_values | jsonb | YES | null | Old values |
| new_values | jsonb | YES | null | New values |
| changes | jsonb | YES | null | Changes |
| event_description | text | YES | null | Event description |
| event_data | jsonb | YES | null | Event data |
| error_details | jsonb | YES | null | Error details |
| created_at | timestamp with time zone | YES | null | Created timestamp |
| request_id | character varying(255) | YES | null | Request ID |
| correlation_id | character varying(255) | YES | null | Correlation ID |
| is_sensitive | boolean | YES | null | Is sensitive |
| retention_period_days | integer | YES | null | Retention period |
| archived_at | timestamp with time zone | YES | null | Archived timestamp |
| application_version | character varying(50) | YES | null | Application version |
| environment | character varying(20) | YES | null | Environment |
| tags | ARRAY | YES | null | Tags |
| user_email | character varying(255) | YES | null | User email |
| amount | numeric | YES | null | Amount |

### 12. **financial_transactions**
Finansal işlemleri tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| payment_id | uuid | YES | null | Payment ID (FK) |
| device_id | uuid | NO | null | Device ID (FK) |
| from_user_id | uuid | YES | null | From user ID (FK) |
| to_user_id | uuid | YES | null | To user ID (FK) |
| transaction_type | character varying(30) | NO | null | Transaction type |
| amount | numeric(10,2) | NO | null | Amount |
| currency | character varying(3) | YES | 'TRY'::character varying | Currency |
| status | character varying(20) | NO | 'pending'::character varying | Status |
| external_transaction_id | character varying(200) | YES | null | External transaction ID |
| external_reference | character varying(200) | YES | null | External reference |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| processed_at | timestamp with time zone | YES | null | Processed timestamp |
| completed_at | timestamp with time zone | YES | null | Completed timestamp |
| description | text | YES | null | Description |
| metadata | jsonb | YES | null | Metadata |
| notes | text | YES | null | Notes |
| debit_account | character varying(50) | YES | null | Debit account |
| credit_account | character varying(50) | YES | null | Credit account |
| created_by | uuid | YES | null | Created by (FK) |
| approved_by | uuid | YES | null | Approved by (FK) |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |

### 13. **invoice_logs**
Fatura loglarını tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| user_id | uuid | NO | null | User ID (FK) |
| device_id | uuid | YES | null | Device ID (FK) |
| device_model | text | YES | null | Device model |
| file_name | text | NO | null | File name |
| file_path | text | NO | null | File path |
| file_size | bigint | NO | null | File size |
| file_type | text | NO | null | File type |
| upload_status | text | NO | 'pending'::text | Upload status |
| verification_status | text | NO | 'pending'::text | Verification status |
| verification_notes | text | YES | null | Verification notes |
| uploaded_at | timestamp with time zone | NO | now() | Uploaded timestamp |
| verified_at | timestamp with time zone | YES | null | Verified timestamp |
| verified_by | uuid | YES | null | Verified by (FK) |
| created_at | timestamp with time zone | NO | now() | Created timestamp |
| updated_at | timestamp with time zone | NO | now() | Updated timestamp |

### 14. **notifications**
Kullanıcı bildirimlerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| user_id | uuid | NO | null | User ID (FK) |
| message_key | text | NO | null | Message key |
| link | text | YES | null | Link |
| is_read | boolean | NO | false | Is read |
| created_at | timestamp with time zone | NO | now() | Created timestamp |
| replacements | jsonb | YES | null | Replacements |
| type | character varying(50) | NO | null | Type |
| message | text | YES | null | Message |

### 15. **payment_summaries**
Ödeme özetlerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | YES | null | Primary key |
| device_id | uuid | YES | null | Device ID (FK) |
| payer_id | uuid | YES | null | Payer ID (FK) |
| receiver_id | uuid | YES | null | Receiver ID (FK) |
| total_amount | numeric(10,2) | YES | null | Total amount |
| reward_amount | numeric(10,2) | YES | null | Reward amount |
| cargo_fee | numeric(10,2) | YES | null | Cargo fee |
| payment_gateway_fee | numeric(10,2) | YES | null | Payment gateway fee |
| service_fee | numeric(10,2) | YES | null | Service fee |
| net_payout | numeric(10,2) | YES | null | Net payout |
| payment_provider | character varying(50) | YES | null | Payment provider |
| provider_payment_id | character varying(200) | YES | null | Provider payment ID |
| provider_transaction_id | character varying(200) | YES | null | Provider transaction ID |
| provider_status | character varying(50) | YES | null | Provider status |
| provider_response | text | YES | null | Provider response |
| escrow_status | character varying(20) | YES | null | Escrow status |
| escrow_held_at | timestamp with time zone | YES | null | Escrow held timestamp |
| escrow_released_at | timestamp with time zone | YES | null | Escrow released timestamp |
| escrow_refunded_at | timestamp with time zone | YES | null | Escrow refunded timestamp |
| payment_status | character varying(20) | YES | null | Payment status |
| payment_method | character varying(50) | YES | null | Payment method |
| created_at | timestamp with time zone | YES | null | Created timestamp |
| updated_at | timestamp with time zone | YES | null | Updated timestamp |
| completed_at | timestamp with time zone | YES | null | Completed timestamp |
| currency | character varying(3) | YES | null | Currency |
| notes | text | YES | null | Notes |
| failure_reason | text | YES | null | Failure reason |
| refund_reason | text | YES | null | Refund reason |
| device_model | text | YES | null | Device model |
| device_serial | text | YES | null | Device serial |
| device_status | text | YES | null | Device status |
| payer_email | character varying(255) | YES | null | Payer email |
| receiver_email | character varying(255) | YES | null | Receiver email |

### 16. **payment_transfers**
Ödeme transferlerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| distribution_id | uuid | NO | null | Distribution ID (FK) |
| transfer_type | character varying(20) | NO | null | Transfer type |
| recipient_type | character varying(20) | NO | null | Recipient type |
| recipient_user_id | uuid | YES | null | Recipient user ID (FK) |
| recipient_name | character varying(100) | NO | null | Recipient name |
| amount | numeric(10,2) | NO | 0.00 | Amount |
| transfer_method | character varying(20) | YES | 'bank_transfer'::character varying | Transfer method |
| transfer_reference | character varying(200) | YES | null | Transfer reference |
| status | character varying(20) | YES | 'pending'::character varying | Status |
| processed_at | timestamp with time zone | YES | null | Processed timestamp |
| failed_reason | text | YES | null | Failed reason |
| notes | text | YES | null | Notes |
| metadata | jsonb | YES | '{}'::jsonb | Metadata |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |

### 17. **payments**
Ödeme işlemlerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| device_id | uuid | NO | null | Device ID (FK) |
| payer_id | uuid | NO | null | Payer ID (FK) |
| receiver_id | uuid | YES | null | Receiver ID (FK) |
| total_amount | numeric(10,2) | NO | null | Total amount |
| reward_amount | numeric(10,2) | NO | null | Reward amount |
| cargo_fee | numeric(10,2) | NO | 25.00 | Cargo fee |
| payment_gateway_fee | numeric(10,2) | NO | 0.00 | Payment gateway fee |
| service_fee | numeric(10,2) | NO | 0.00 | Service fee |
| net_payout | numeric(10,2) | NO | 0.00 | Net payout |
| payment_provider | character varying(50) | NO | 'iyzico'::character varying | Payment provider |
| provider_payment_id | character varying(200) | YES | null | Provider payment ID |
| provider_transaction_id | character varying(200) | YES | null | Provider transaction ID |
| provider_status | character varying(50) | YES | null | Provider status |
| provider_response | text | YES | null | Provider response |
| escrow_status | character varying(20) | NO | 'pending'::character varying | Escrow status |
| escrow_held_at | timestamp with time zone | YES | null | Escrow held timestamp |
| escrow_released_at | timestamp with time zone | YES | null | Escrow released timestamp |
| escrow_refunded_at | timestamp with time zone | YES | null | Escrow refunded timestamp |
| payment_status | character varying(20) | NO | 'pending'::character varying | Payment status |
| payment_method | character varying(50) | YES | null | Payment method |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |
| completed_at | timestamp with time zone | YES | null | Completed timestamp |
| currency | character varying(3) | YES | 'TRY'::character varying | Currency |
| notes | text | YES | null | Notes |
| failure_reason | text | YES | null | Failure reason |
| refund_reason | text | YES | null | Refund reason |
| payer_info | jsonb | YES | null | Payer info |
| device_info | jsonb | YES | null | Device info |
| billing_address | jsonb | YES | null | Billing address |
| shipping_address | jsonb | YES | null | Shipping address |
| card_last_four | character varying(4) | YES | null | Card last four |
| card_brand | character varying(20) | YES | null | Card brand |
| card_expiry_month | character varying(2) | YES | null | Card expiry month |
| card_expiry_year | character varying(4) | YES | null | Card expiry year |
| card_holder_name | character varying(100) | YES | null | Card holder name |
| fraud_score | integer | YES | 0 | Fraud score |
| ip_address | inet | YES | null | IP address |
| user_agent | text | YES | null | User agent |
| risk_level | character varying(20) | YES | 'low'::character varying | Risk level |
| threeds_enrolled | boolean | YES | false | 3DS enrolled |
| threeds_status | character varying(20) | YES | null | 3DS status |
| threeds_eci | character varying(2) | YES | null | 3DS ECI |
| threeds_cavv | character varying(50) | YES | null | 3DS CAVV |
| webhook_received_at | timestamp with time zone | YES | null | Webhook received timestamp |
| webhook_attempts | integer | YES | 0 | Webhook attempts |
| callback_url | text | YES | null | Callback URL |
| webhook_signature | text | YES | null | Webhook signature |
| compliance_status | character varying(20) | YES | 'pending'::character varying | Compliance status |
| kyc_verified | boolean | YES | false | KYC verified |
| aml_checked | boolean | YES | false | AML checked |
| audit_trail | jsonb | YES | null | Audit trail |
| refund_amount | numeric(10,2) | YES | 0.00 | Refund amount |
| refund_reason_code | character varying(20) | YES | null | Refund reason code |
| dispute_status | character varying(20) | YES | 'none'::character varying | Dispute status |
| dispute_reason | text | YES | null | Dispute reason |
| processing_time_ms | integer | YES | null | Processing time |
| gateway_response_time_ms | integer | YES | null | Gateway response time |
| retry_count | integer | YES | 0 | Retry count |
| success_rate | numeric(5,2) | YES | null | Success rate |
| status | character varying(20) | NO | 'pending'::character varying | Status |
| gross_amount | numeric(10,2) | YES | 0.00 | Gross amount |
| net_amount | numeric(10,2) | YES | 0.00 | Net amount |
| iyzico_commission | numeric(10,2) | YES | 0.00 | Iyzico commission |

### 18. **security_audit_events**
Güvenlik audit olaylarını tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | YES | null | Primary key |
| event_type | character varying(50) | YES | null | Event type |
| event_category | character varying(30) | YES | null | Event category |
| event_action | character varying(30) | YES | null | Event action |
| event_severity | character varying(20) | YES | null | Event severity |
| user_id | uuid | YES | null | User ID |
| session_id | character varying(255) | YES | null | Session ID |
| ip_address | inet | YES | null | IP address |
| user_agent | text | YES | null | User agent |
| resource_type | character varying(50) | YES | null | Resource type |
| resource_id | uuid | YES | null | Resource ID |
| parent_resource_type | character varying(50) | YES | null | Parent resource type |
| parent_resource_id | uuid | YES | null | Parent resource ID |
| old_values | jsonb | YES | null | Old values |
| new_values | jsonb | YES | null | New values |
| changes | jsonb | YES | null | Changes |
| event_description | text | YES | null | Event description |
| event_data | jsonb | YES | null | Event data |
| error_details | jsonb | YES | null | Error details |
| created_at | timestamp with time zone | YES | null | Created timestamp |
| request_id | character varying(255) | YES | null | Request ID |
| correlation_id | character varying(255) | YES | null | Correlation ID |
| is_sensitive | boolean | YES | null | Is sensitive |
| retention_period_days | integer | YES | null | Retention period |
| archived_at | timestamp with time zone | YES | null | Archived timestamp |
| application_version | character varying(50) | YES | null | Application version |
| environment | character varying(20) | YES | null | Environment |
| tags | ARRAY | YES | null | Tags |
| user_email | character varying(255) | YES | null | User email |

### 19. **shipment_tracking**
Kargo takibini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | YES | null | Primary key |
| device_id | uuid | YES | null | Device ID (FK) |
| tracking_number | character varying(100) | YES | null | Tracking number |
| cargo_company | character varying(50) | YES | null | Cargo company |
| status | character varying(30) | YES | null | Status |
| created_at | timestamp with time zone | YES | null | Created timestamp |
| picked_up_at | timestamp with time zone | YES | null | Picked up timestamp |
| delivered_at | timestamp with time zone | YES | null | Delivered timestamp |
| estimated_delivery_days | integer | YES | null | Estimated delivery days |
| delivery_confirmed_by_receiver | boolean | YES | null | Delivery confirmed by receiver |
| device_model | text | YES | null | Device model |
| user_anonymous_id | character varying | YES | null | User anonymous ID |
| user_role | text | YES | null | User role |

### 20. **user_escrow_history**
Kullanıcı escrow geçmişini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | YES | null | Primary key |
| payment_id | uuid | YES | null | Payment ID (FK) |
| device_id | uuid | YES | null | Device ID (FK) |
| total_amount | numeric(10,2) | YES | null | Total amount |
| reward_amount | numeric(10,2) | YES | null | Reward amount |
| net_payout | numeric(10,2) | YES | null | Net payout |
| status | character varying(20) | YES | null | Status |
| created_at | timestamp with time zone | YES | null | Created timestamp |
| held_at | timestamp with time zone | YES | null | Held timestamp |
| released_at | timestamp with time zone | YES | null | Released timestamp |
| refunded_at | timestamp with time zone | YES | null | Refunded timestamp |
| confirmations | jsonb | YES | null | Confirmations |
| device_model | text | YES | null | Device model |
| device_serial | text | YES | null | Device serial |
| user_role | text | YES | null | User role |
| user_role_description | text | YES | null | User role description |

### 21. **user_rating_stats**
Kullanıcı değerlendirme istatistiklerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| rated_user_id | uuid | YES | null | Rated user ID (FK) |
| rating_count | integer | YES | null | Rating count |
| rating_avg | numeric(4,2) | YES | null | Rating average |
| rating_median | double precision | YES | null | Rating median |
| first_rating_at | timestamp with time zone | YES | null | First rating timestamp |
| last_rating_at | timestamp with time zone | YES | null | Last rating timestamp |

### 22. **user_ratings**
Kullanıcı değerlendirmelerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| rater_user_id | uuid | NO | null | Rater user ID (FK) |
| rated_user_id | uuid | NO | null | Rated user ID (FK) |
| rating | smallint | NO | null | Rating |
| review | text | YES | null | Review |
| context | character varying(30) | NO | 'general'::character varying | Context |
| device_id | uuid | YES | null | Device ID (FK) |
| payment_id | uuid | YES | null | Payment ID (FK) |
| dispute_id | uuid | YES | null | Dispute ID (FK) |
| is_public | boolean | NO | true | Is public |
| created_at | timestamp with time zone | NO | now() | Created timestamp |
| updated_at | timestamp with time zone | NO | now() | Updated timestamp |

### 23. **user_transaction_history**
Kullanıcı işlem geçmişini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | YES | null | Primary key |
| payment_id | uuid | YES | null | Payment ID (FK) |
| device_id | uuid | YES | null | Device ID (FK) |
| transaction_type | character varying(30) | YES | null | Transaction type |
| amount | numeric(10,2) | YES | null | Amount |
| currency | character varying(3) | YES | null | Currency |
| status | character varying(20) | YES | null | Status |
| created_at | timestamp with time zone | YES | null | Created timestamp |
| completed_at | timestamp with time zone | YES | null | Completed timestamp |
| description | text | YES | null | Description |
| device_model | text | YES | null | Device model |
| device_serial | text | YES | null | Device serial |
| transaction_direction | text | YES | null | Transaction direction |

### 24. **userprofile**
Kullanıcı profil bilgilerini tutan tablo.

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | gen_random_uuid() | Primary key |
| user_id | uuid | NO | null | User ID (FK) |
| bank_info | text | YES | null | Bank info |
| phone_number | character varying(20) | YES | null | Phone number |
| address | text | YES | null | Address |
| city | character varying(100) | YES | null | City |
| country | character varying(100) | YES | null | Country |
| postal_code | character varying(20) | YES | null | Postal code |
| date_of_birth | date | YES | null | Date of birth |
| emergency_contact | text | YES | null | Emergency contact |
| preferences | jsonb | YES | '{}'::jsonb | Preferences |
| created_at | timestamp with time zone | YES | now() | Created timestamp |
| updated_at | timestamp with time zone | YES | now() | Updated timestamp |
| tc_kimlik_no | character varying(11) | YES | null | TC Kimlik No |
| iban | character varying(34) | YES | null | IBAN |
| first_name | character varying(100) | YES | null | First name |
| last_name | character varying(100) | YES | null | Last name |

---

## 🔒 **RLS POLİTİKALARI**

### **admin_permissions**
- **Admins can view their own permissions**: Users can view their own admin permissions or if they have admin/super_admin role
- **Allow users to read their own admin permissions**: Users can read their own admin permissions
- **Super admins can manage all admin permissions**: Super admins can manage all admin permissions

### **audit_logs**
- **Admins can view all audit logs**: Authenticated users can view all audit logs
- **System can insert audit logs**: Authenticated users can insert audit logs
- **Users can view own audit logs**: Users can view their own non-sensitive audit logs (excluding error/critical severity)

### **cargo_codes**
- **Admins can view all cargo codes**: Admins can view all cargo codes
- **Users can create own cargo codes**: Users can create their own cargo codes
- **Users can update own cargo codes**: Users can update their own cargo codes
- **Users can view own cargo codes**: Users can view their own cargo codes

### **cargo_companies**
- **Allow read cargo companies**: Authenticated users can read cargo companies

### **cargo_shipments**
- **Users can create shipments**: Users can create shipments (sender or receiver)
- **Users can update own shipments**: Users can update their own shipments
- **Users can view own shipments**: Users can view their own shipments

### **delivery_confirmations**
- **Admins can view all delivery confirmations**: Admins can view all delivery confirmations
- **Users can create own delivery confirmations**: Users can create their own delivery confirmations
- **Users can update own delivery confirmations**: Users can update their own delivery confirmations
- **Users can view own delivery confirmations**: Users can view their own delivery confirmations

### **device_models**
- **Allow public read access to device_models**: Public read access
- **Allow read access for authenticated users**: Authenticated users can read device models

### **devices**
- **Users can delete own devices**: Users can delete their own devices
- **Users can insert own devices**: Users can insert their own devices
- **Users can update own devices**: Users can update their own devices
- **Users can view own devices**: Users can view their own devices
- **allow_delete_own_devices**: Duplicate policy for delete
- **allow_insert_own_devices**: Duplicate policy for insert
- **allow_select_own_devices**: Duplicate policy for select
- **allow_update_own_devices**: Duplicate policy for update
- **allow_view_for_matching**: Authenticated users can view devices with LOST/FOUND status for matching

### **escrow_accounts**
- **System can manage escrow accounts**: Authenticated users can manage escrow accounts
- **Users can view own escrow accounts**: Users can view their own escrow accounts (holder or beneficiary)

### **final_payment_distributions**
- **Admins can create payment distributions**: Admins can create payment distributions
- **Admins can update payment distributions**: Admins can update payment distributions
- **Admins can view all payment distributions**: Admins can view all payment distributions

### **financial_transactions**
- **System can manage transactions**: Authenticated users can manage transactions
- **Users can view own transactions**: Users can view their own transactions (from_user, to_user, or device owner)

### **invoice_logs**
- **Admins can view all invoice logs**: Admins can view all invoice logs
- **Users can insert own invoice logs**: Users can insert their own invoice logs
- **Users can update own invoice logs**: Users can update their own invoice logs
- **Users can view own invoice logs**: Users can view their own invoice logs

### **notifications**
- **Allow authenticated users to insert their own notifications**: Users can insert their own notifications
- **Allow authenticated users to select their own notifications**: Users can select their own notifications
- **Allow authenticated users to update their own notifications**: Users can update their own notifications

### **payment_transfers**
- **Admins can create payment transfers**: Admins can create payment transfers
- **Admins can update payment transfers**: Admins can update payment transfers
- **Admins can view all payment transfers**: Admins can view all payment transfers
- **Users can view own payment transfers**: Users can view their own payment transfers

### **payments**
- **Payers can create payments**: Users can create payments
- **System can update payments**: Authenticated users can update payments
- **Users can view own payments**: Users can view their own payments (payer or receiver)
- **Users can view payments by status**: Users can view payments by status (payer or receiver)

### **user_ratings**
- **delete_own_ratings**: Authenticated users can delete their own ratings
- **insert_own_ratings**: Authenticated users can insert their own ratings
- **select_public_or_related_user**: Anonymous and authenticated users can select public ratings or ratings related to them
- **update_own_ratings**: Authenticated users can update their own ratings

### **userprofile**
- **Users can delete own profile**: Users can delete their own profile
- **Users can insert own profile**: Users can insert their own profile
- **Users can update own profile**: Users can update their own profile
- **Users can view own profile**: Users can view their own profile

---

## 🔗 **FOREIGN KEY İLİŞKİLERİ**

### **cargo_codes**
- `device_id` → `devices.id`
- `payment_id` → `payments.id`

### **cargo_shipments**
- `device_id` → `devices.id`
- `payment_id` → `payments.id`
- `delivery_confirmation_id` → `delivery_confirmations.id`

### **delivery_confirmations**
- `device_id` → `devices.id`
- `payment_id` → `payments.id`
- `cargo_shipment_id` → `cargo_shipments.id`

### **devices**
- `userId` → `auth.users.id`
- `cargo_code_id` → `cargo_codes.id`

### **escrow_accounts**
- `payment_id` → `payments.id`
- `device_id` → `devices.id`
- `holder_user_id` → `auth.users.id`
- `beneficiary_user_id` → `auth.users.id`
- `created_by` → `auth.users.id`
- `released_by` → `auth.users.id`
- `refunded_by` → `auth.users.id`

### **final_payment_distributions**
- `device_id` → `devices.id`
- `payment_id` → `payments.id`
- `escrow_account_id` → `escrow_accounts.id`

### **financial_transactions**
- `device_id` → `devices.id`
- `payment_id` → `payments.id`
- `from_user_id` → `auth.users.id`
- `to_user_id` → `auth.users.id`

### **invoice_logs**
- `user_id` → `auth.users.id`
- `device_id` → `devices.id`
- `verified_by` → `auth.users.id`

### **notifications**
- `user_id` → `auth.users.id`

### **payment_transfers**
- `distribution_id` → `final_payment_distributions.id`
- `recipient_user_id` → `auth.users.id`

### **payments**
- `device_id` → `devices.id`
- `payer_id` → `auth.users.id`
- `receiver_id` → `auth.users.id`

### **user_ratings**
- `rater_user_id` → `auth.users.id`
- `rated_user_id` → `auth.users.id`
- `device_id` → `devices.id`
- `payment_id` → `payments.id`

### **userprofile**
- `user_id` → `auth.users.id`

---

## 📝 **NOTLAR**

1. **Duplicate Policies**: `devices` tablosunda bazı RLS politikaları duplicate olarak tanımlanmış. Temizlenmesi önerilir.

2. **Status Fields**: Birçok tabloda `status` field'ı var. Tutarlılık için standartlaştırılması önerilir.

3. **Timestamps**: Tüm tablolarda `created_at` ve `updated_at` field'ları mevcut.

4. **JSONB Fields**: Birçok tabloda JSONB field'lar kullanılıyor (audit_logs, escrow_accounts, payments, userprofile, vb.).

5. **Encryption**: `cargo_shipments` tablosunda adres bilgileri encrypted olarak saklanıyor.

6. **New Tables**: Bu güncellemede 14 yeni tablo eklendi ve mevcut tablolar genişletildi.

7. **Admin System**: `admin_permissions` tablosu ile admin yetki sistemi eklendi.

8. **Rating System**: `user_ratings` ve `user_rating_stats` tabloları ile kullanıcı değerlendirme sistemi eklendi.

9. **Enhanced Tracking**: Kargo takibi ve teslimat onayları için gelişmiş sistem eklendi.

10. **Financial Audit**: Finansal işlemler için detaylı audit trail sistemi eklendi.

---

## 🔄 **GÜNCELLEME TALİMATLARI**

Bu dosyayı güncellerken:

1. **Tablo yapısı değişiklikleri** → İlgili tablo bölümünü güncelleyin
2. **RLS politikası değişiklikleri** → RLS politikaları bölümünü güncelleyin
3. **Foreign key değişiklikleri** → Foreign key ilişkileri bölümünü güncelleyin
4. **Versiyon numarasını** artırın
5. **Son güncelleme tarihini** güncelleyin

---

**Bu dosya sürekli güncel tutulmalı ve database değişikliklerinde referans olarak kullanılmalıdır.**